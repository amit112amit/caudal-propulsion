import numba
import numpy as np
from math import sqrt, sin, cos, acos, atan2

@numba.njit
def residual(t, yin, yp, R, L1, L2, H, Ct, Cdv, Cd, St, Sv, rho, Ma, Mv, Iv, theta):
    """Calculates the residual of the system of equations G(t, y, yp) == 0."""
    x,y,p,x1,y1,p1 = yin
    x2,y2,p2 = yp[3:6]
    t1,dt1,ddt1,t2,dt2,ddt2 = theta(t)
    # Test direction of Vn1
    r1 = 0.5*L1
    Vn1 = (-R*sin(p)*p1 - r1*(p1 + dt1)*sin(p + t1) + x1)*sin(p + t1) - (R*cos(p)*p1 + r1*(p1 + dt1)*cos(p + t1) + y1)*cos(p + t1)
    s1 = 1.0 if Vn1 > 0 else -1.0
    # Test direction of Vn2
    r2 = 0.5*L2    
    Vn2 = (-L1*(p1 + dt1)*sin(p + t1) - R*sin(p)*p1 - r2*(p1 + dt1 + dt2)*sin(p + t1 + t2) + x1)*sin(p + t1 + t2) - (L1*(p1 + dt1)*cos(p + t1) + R*cos(p)*p1 + r2*(p1 + dt1 + dt2)*cos(p + t1 + t2) + y1)*cos(p + t1 + t2)
    s2 = 1.0 if Vn2 > 0 else -1.0
    s3 = 1.0 if p1 > 0 else -1.0
    Z1 = 0.5*rho*Cd*H
    Z2 = 0.5*rho*Cdv*Sv
    Z3 = 0.5*rho*Ct*St

    # Now calculate the residuals
    f = np.empty(6)
    f[0] = yp[0] - x1;
    f[1] = yp[1] - y1;
    f[2] = yp[2] - p1;

    # First calculate the common sub-expressions
    term0 = x1**2
    term1 = y1**2
    term2 = Z2*sqrt(term0 + term1)
    term3 = L1**2
    term4 = p + t1
    term5 = sin(term4)
    term6 = term5**3
    term7 = (1/2)*Ma
    term8 = term6*term7
    term9 = Ma*dt1
    term10 = cos(term4)
    term11 = term10**3
    term12 = p1*term11
    term13 = dt1**2
    term14 = term11*term7
    term15 = p1**2
    term16 = term10**2
    term17 = term16*term5
    term18 = term17*term7
    term19 = p1*term9
    term20 = term5**2
    term21 = term10*term20
    term22 = term13*term7
    term23 = term15*term7
    term24 = term3*(ddt1*term18 + ddt1*term8 + p2*term18 + p2*term8 + term12*term9 + term13*term14 + term14*term15 + term19*term21 + term21*term22 + term21*term23)
    term25 = L1**3
    term26 = Z1*s1
    term27 = term26*term5**5
    term28 = (2/3)*dt1
    term29 = p1*term28
    term30 = (1/3)*term13
    term31 = (1/3)*term15
    term32 = term10**4*term26
    term33 = term32*term5
    term34 = dt1*term16
    term35 = term26*term6
    term36 = (4/3)*p1
    term37 = (2/3)*term13
    term38 = term16*term35
    term39 = (2/3)*term15
    term40 = term25*(-term27*term29 - term27*term30 - term27*term31 - term29*term33 - term30*term33 - term31*term33 - term34*term35*term36 - term37*term38 - term38*term39)
    term41 = Z1*term0
    term42 = s1*term41
    term43 = sin(p)
    term44 = R*term43
    term45 = p1*x1
    term46 = 2*term45
    term47 = term44*term46
    term48 = term21*term26
    term49 = 2*x1
    term50 = term49*y1
    term51 = Z1*term1
    term52 = s1*term51
    term53 = cos(p)
    term54 = R*term53
    term55 = term46*term54
    term56 = p1*y1
    term57 = 2*term56
    term58 = term20*term44
    term59 = term26*term58
    term60 = term10*term59
    term61 = term17*term26
    term62 = 2*term54
    term63 = term56*term62
    term64 = R**2*term15
    term65 = term43**2*term64
    term66 = term53**2*term64
    term67 = 2*term43*term53*term64
    term68 = L1*(-term17*term52 + term35*term47 - term35*term65 - term42*term6 + term48*term50 + term48*term55 - term48*term67 - term57*term60 - term61*term63 - term61*term66)
    term69 = Ma*x2
    term70 = Ma*y1
    term71 = p1*term70
    term72 = dt1*term70
    term73 = Ma*y2
    term74 = term10*term5
    term75 = Ma*p2
    term76 = term9*x1
    term77 = 2*term74
    term78 = Ma*p1
    term79 = term78*x1
    term80 = term34*term78
    term81 = Ma*term15
    term82 = term16*term54
    term83 = term19*term54
    term84 = term54*term75
    term85 = term44*term81
    term86 = term19*term44
    term87 = L1*(term16*term71 - term20*term69 - term20*term71 - term20*term72 - term20*term83 + term34*term70 + term54*term80 + term58*term75 + term73*term74 + term74*term84 + term74*term85 - term76*term77 - term77*term79 + term77*term86 + term81*term82)
    term88 = L2**2
    term89 = t2 + term4
    term90 = sin(term89)
    term91 = term90**3
    term92 = term7*term91
    term93 = cos(term89)
    term94 = term93**3
    term95 = term9*term94
    term96 = dt2*term94
    term97 = term7*term94
    term98 = dt2**2
    term99 = term93**2
    term100 = term90*term99
    term101 = term100*term7
    term102 = term90**2
    term103 = term102*term93
    term104 = dt2*term103
    term105 = term103*term7
    term106 = term88*(ddt1*term101 + ddt1*term92 + ddt2*term101 + ddt2*term92 + dt2*term95 + p1*term95 + p2*term101 + p2*term92 + term103*term19 + term103*term22 + term103*term23 + term104*term78 + term104*term9 + term105*term98 + term13*term97 + term15*term97 + term78*term96 + term97*term98)
    term107 = dt1*x1
    term108 = term26*term5**4
    term109 = p1*term44
    term110 = dt1*term109
    term111 = term15*term44
    term112 = dt1*y1
    term113 = term26*term5
    term114 = term11*term113
    term115 = term10*term35
    term116 = term113*term12
    term117 = term20*term26
    term118 = term117*term34
    term119 = term117*term16
    term120 = dt1*term116
    term121 = p1*term54
    term122 = dt1*term121
    term123 = term15*term54
    term124 = p1*term34
    term125 = term3*(term107*term108 - term108*term110 - term108*term111 + term108*term45 - term112*term114 - term112*term115 - term114*term123 - term115*term122 - term115*term123 - term115*term56 - term116*y1 + term118*x1 + term119*term45 - term120*term54 - term124*term59 - term15*term16*term59)
    term126 = L2**3
    term127 = Z1*s2
    term128 = term127*term90**5
    term129 = dt2*term128
    term130 = (2/3)*p1
    term131 = (1/3)*term98
    term132 = term127*term93**4
    term133 = term132*term90
    term134 = dt2*term133
    term135 = dt2*term91
    term136 = term127*term99
    term137 = term135*term136
    term138 = (4/3)*dt1
    term139 = term127*term91
    term140 = term139*term99
    term141 = dt1*term36
    term142 = (2/3)*term98
    term143 = term126*(-term128*term131 - term128*term29 - term128*term30 - term128*term31 - term129*term130 - term129*term28 - term130*term134 - term131*term133 - term133*term29 - term133*term30 - term133*term31 - term134*term28 - term137*term138 - term137*term36 - term140*term141 - term140*term142 - term140*term37 - term140*term39)
    term144 = dt2*term70
    term145 = term90*term93
    term146 = term102*term44
    term147 = term54*term99
    term148 = dt2*term78
    term149 = L1*term5
    term150 = term102*term149
    term151 = Ma*ddt1
    term152 = 2*term145
    term153 = Ma*x1
    term154 = dt2*term153
    term155 = term148*term54
    term156 = L1*term10
    term157 = term156*term99
    term158 = dt2*term157
    term159 = Ma*term13
    term160 = term102*term156
    term161 = dt2*term9
    term162 = 2*term19
    term163 = term145*term156
    term164 = term148*term152
    term165 = term145*term149
    term166 = term149*term152
    term167 = L2*(-term102*term144 - term102*term155 - term102*term69 - term102*term71 - term102*term72 - term102*term83 + term144*term99 + term145*term73 + term145*term84 + term145*term85 + term146*term75 + term147*term148 + term147*term19 + term147*term81 - term148*term160 + term148*term166 + term150*term151 + term150*term75 + term151*term163 - term152*term154 - term152*term76 - term152*term79 + term152*term86 + term157*term159 + term157*term162 + term157*term81 + term158*term78 + term158*term9 + term159*term165 - term160*term161 + term161*term166 + term163*term75 + term164*term44 + term165*term81 + term166*term19 + term71*term99 + term72*term99)
    term168 = s2*term41
    term169 = term127*y1
    term170 = term169*term49
    term171 = term139*term149
    term172 = 2*term171
    term173 = s2*term51
    term174 = term103*term127
    term175 = term127*term93
    term176 = term146*term175
    term177 = term100*term127
    term178 = term139*term3
    term179 = dt1*p1
    term180 = 2*term179
    term181 = term180*term20
    term182 = term13*term20
    term183 = term15*term20
    term184 = term107*term127
    term185 = 2*term184
    term186 = term156*term185
    term187 = term150*term175
    term188 = 2*term187
    term189 = 2*term177
    term190 = term112*term189
    term191 = term156*term177
    term192 = term156*term180
    term193 = term156*term189
    term194 = term124*term3
    term195 = term15*term156
    term196 = term123*term189
    term197 = term16*term3
    term198 = term177*term197
    term199 = term174*term3
    term200 = 4*term179*term74
    term201 = term199*term77
    term202 = L2*(-term100*term173 + term103*term170 + term103*term186 + term107*term172 - term110*term172 - term111*term172 - term112*term188 - term122*term188 - term122*term193 - term123*term188 - term13*term198 - term13*term201 + term139*term47 - term139*term65 - term15*term198 - term15*term201 + term156*term174*term46 - term156*term190 - term156*term196 - term168*term91 + term171*term46 + term174*term55 - term174*term67 - term176*term192 - 2*term176*term195 - term176*term57 - term177*term63 - term177*term66 - term178*term181 - term178*term182 - term178*term183 - term187*term57 - term189*term194 - term191*term57 - term199*term200)
    term203 = term127*term90**4
    term204 = dt2*x1
    term205 = term127*term90
    term206 = term205*term94
    term207 = term139*term93
    term208 = term205*term96
    term209 = term135*term93
    term210 = term149*term203
    term211 = dt2*term210
    term212 = term102*term99
    term213 = term127*term212
    term214 = term127*term209
    term215 = dt1*term156
    term216 = p1*term156
    term217 = term136*term146
    term218 = dt2*p1
    term219 = term13*term156
    term220 = term136*term150
    term221 = dt2*term220
    term222 = term88*(-dt1*term211 - dt1*term221 - dt2*term109*term203 - p1*term211 - p1*term221 + term107*term203 - term110*term203 - term111*term203 - term112*term206 - term112*term207 - term121*term208 - term121*term214 - term122*term206 - term122*term207 - term123*term206 - term123*term207 - term13*term210 - term13*term220 - term15*term210 - term15*term217 - term15*term220 - term169*term209 - term179*term217 - term180*term210 - term180*term220 + term184*term212 - term192*term206 - term192*term207 - term195*term206 - term195*term207 + term203*term204 + term203*term45 + term204*term213 - term206*term219 - term206*term56 - term207*term219 - term207*term56 - term208*term215 - term208*term216 - term208*y1 + term213*term45 - term214*term215 - term214*term216 - term217*term218)
    term223 = term21*term7
    term224 = term3*(-ddt1*term14 - ddt1*term223 - p2*term14 - p2*term223 + term13*term18 + term13*term8 + term15*term18 + term15*term8 + term19*term6 + term5*term80)
    term225 = term10**5*term26
    term226 = term10*term108
    term227 = term11*term26
    term228 = (2/3)*term227
    term229 = term25*(term117*term12*term138 + term182*term228 + term183*term228 + term225*term29 + term225*term30 + term225*term31 + term226*term29 + term226*term30 + term226*term31)
    term230 = term44*term57
    term231 = L1*(term11*term52 + term12*term26*term62*y1 + term21*term42 + term227*term66 + term230*term61 - term46*term60 + term48*term65 - term50*term61 - term55*term61 + term61*term67)
    term232 = term44*term75
    term233 = term54*term81
    term234 = L1*(term153*term34 - term16*term73 + term16*term79 + term19*term58 - term20*term76 - term20*term79 - term232*term74 + term233*term74 - term44*term80 + term58*term81 + term69*term74 + term71*term77 + term72*term77 - term75*term82 + term77*term83)
    term235 = dt2*term100
    term236 = term88*(-ddt1*term105 - ddt1*term97 - ddt2*term105 - ddt2*term97 - p2*term105 - p2*term97 + term100*term19 + term100*term22 + term100*term23 + term101*term98 + term13*term92 + term135*term78 + term135*term9 + term15*term92 + term19*term91 + term235*term78 + term235*term9 + term92*term98)
    term237 = term3*(-term107*term114 - term107*term115 + term110*term115 + term111*term114 + term111*term115 + term112*term32 - term115*term45 - term116*x1 + term118*term121 + term118*y1 + term119*term56 + term120*term44 + term122*term32 + term123*term32 + term183*term26*term82 + term32*term56)
    term238 = term127*term93**5
    term239 = dt2*term238
    term240 = term203*term93
    term241 = dt2*term240
    term242 = term102*term127
    term243 = term242*term96
    term244 = term127*term94
    term245 = term102*term244
    term246 = term126*(term130*term239 + term130*term241 + term131*term238 + term131*term240 + term138*term243 + term141*term245 + term142*term245 + term238*term29 + term238*term30 + term238*term31 + term239*term28 + term240*term29 + term240*term30 + term240*term31 + term241*term28 + term243*term36 + term245*term37 + term245*term39)
    term247 = term44*term99
    term248 = term149*term99
    term249 = term152*term156
    term250 = L2*(-term102*term154 - term102*term76 - term102*term79 + term144*term152 - term145*term232 + term145*term233 + term145*term69 + term146*term148 + term146*term19 + term146*term81 - term147*term75 + term148*term150 - term148*term247 - term148*term248 + term150*term159 + term150*term161 + term150*term162 + term150*term81 - term151*term157 - term151*term165 + term152*term155 + term152*term71 + term152*term72 + term152*term83 + term154*term99 + term156*term164 - term157*term75 + term159*term163 - term161*term248 + term161*term249 + term163*term81 - term165*term75 - term19*term247 + term19*term249 - term73*term99 + term76*term99 + term79*term99)
    term251 = 2*term244
    term252 = term156*term251
    term253 = term197*term244
    term254 = term177*term3
    term255 = term254*term77
    term256 = L2*(-term100*term170 - term100*term186 + term103*term168 + term110*term188 + term110*term193 + term111*term188 + term111*term193 + term112*term252 + term122*term149*term189 + term122*term252 + term123*term252 + term13*term253 + term13*term255 + term149*term177*term57 + term149*term190 + term149*term196 + term15*term253 + term15*term255 - term150*term185*term93 + term173*term94 + term174*term65 - term176*term46 + term177*term230 - term177*term55 + term177*term67 + term181*term199 + term182*term199 + term183*term199 - term187*term46 - term191*term46 + term194*term251 + term200*term254 + term244*term63 + term244*term66 + term252*term56)
    term257 = dt2*y1
    term258 = term132*term156
    term259 = dt2*term258
    term260 = dt1*term149
    term261 = p1*term149
    term262 = term147*term242
    term263 = term13*term149
    term264 = term149*term15
    term265 = term149*term180
    term266 = term158*term242
    term267 = term157*term242
    term268 = term88*(dt1*term259 + dt1*term266 + dt2*term121*term132 + p1*term259 + p1*term266 - term107*term207 + term109*term208 + term109*term214 + term110*term206 + term110*term207 + term111*term206 + term111*term207 + term112*term132 + term112*term213 + term122*term132 + term123*term132 + term13*term258 + term13*term267 + term132*term257 + term132*term56 + term15*term258 + term15*term262 + term15*term267 + term179*term262 + term180*term258 + term180*term267 - term184*term90*term94 + term206*term263 + term206*term264 + term206*term265 - term206*term45 + term207*term263 + term207*term264 + term207*term265 - term207*term45 + term208*term260 + term208*term261 - term208*x1 + term213*term257 + term213*term56 + term214*term260 + term214*term261 - term214*x1 + term218*term262)
    term269 = (3/4)*L2
    term270 = term149 + term269*term90 + term44
    term271 = sqrt(term270**2 + (term156 + term269*term93 + term54)**2)

    # Now the remaining elements of `f`
    f[3] = Mv*x2 - term106 - term125 - term143 - term167 + term2*x1 - term202 - term222 - term24 - term40 - term68 - term87
    f[4] = Mv*y2 + term2*y1 - term224 - term229 - term231 - term234 - term236 - term237 - term246 - term250 - term256 - term268
    f[5] = Iv*p2 + Z3*s3*term15 - s1*((3/4)*L1 + R*cos(t1))*sqrt((term125 + term24 + term40 + term68 + term87)**2 + (term224 + term229 + term231 + term234 + term237)**2) - s2*term271*sqrt((term106 + term143 + term167 + term202 + term222)**2 + (term236 + term246 + term250 + term256 + term268)**2)*sin(term89 + acos(term270/term271))

    return f
